# payments/payme_utils.py - TEST VA PRODUCTION REJIMI
import base64
import json
from django.conf import settings


def create_payme_link(telegram_id, amount):
    """
    Payme to'lov havolasini yaratish

    Args:
        telegram_id: Foydalanuvchi telegram ID (int yoki str)
        amount: Summa (so'mda, float)

    Returns:
        str: Payme to'lov havolasi
    """
    try:
        # Settings dan merchant_id ni olish
        merchant_id = getattr(settings, 'PAYME_MERCHANT_ID', '')

        # ‚ö†Ô∏è TEST REJIMI - agar merchant_id yo'q bo'lsa, test URL qaytarish
        if not merchant_id:
            print("‚ö†Ô∏è WARNING: PAYME_MERCHANT_ID not configured, using TEST mode")
            # Test uchun fake URL (bu URL ishlamaydi, faqat test uchun)
            test_url = f"https://checkout.test.paycom.uz?amount={amount}&telegram_id={telegram_id}&test=true"
            print(f"üß™ TEST Payme URL: {test_url}")
            return test_url

        # Summa tiyinga (1 so'm = 100 tiyin)
        try:
            amount_float = float(amount)
            amount_tiyin = int(amount_float * 100)
        except (ValueError, TypeError):
            print(f"ERROR: Invalid amount: {amount}")
            return ""

        # Account parametrlari - FAQAT telegram_id
        account_params = {
            'telegram_id': str(telegram_id)
        }

        # Parametrlarni string formatga o'tkazish
        params_list = [f"m={merchant_id}"]

        # Account parametrlarini qo'shish
        for key, value in account_params.items():
            if value:
                params_list.append(f"ac.{key}={value}")

        # Summa parametri
        params_list.append(f"a={amount_tiyin}")

        # Barcha parametrlarni birlashtirish
        params_str = ";".join(params_list)

        # Base64 kodlash
        encoded = base64.b64encode(params_str.encode('utf-8')).decode('utf-8')

        # URL yaratish
        url = f"https://checkout.paycom.uz/{encoded}"

        print(f"‚úÖ Payme URL created: {url}")
        print(f"üìã Params: {params_str}")

        return url

    except Exception as e:
        print(f"‚ùå ERROR creating Payme link: {e}")
        # Xatolik bo'lsa ham test URL qaytarish
        test_url = f"https://checkout.test.paycom.uz?error=true&amount={amount}&telegram_id={telegram_id}"
        return test_url


def check_payme_auth(request):
    """
    Payme dan kelayotgan so'rovni autentifikatsiya qilish
    """
    try:
        auth_header = request.META.get('HTTP_AUTHORIZATION', '')

        if not auth_header.startswith('Basic '):
            print(f"Invalid auth header: {auth_header[:50]}...")
            return False

        encoded_credentials = auth_header.split(' ')[1]
        decoded_credentials = base64.b64decode(encoded_credentials).decode('utf-8')

        secret_key = getattr(settings, 'PAYME_SECRET_KEY', '')
        if not secret_key:
            print("ERROR: PAYME_SECRET_KEY not configured")
            return False

        expected_credentials = f"Paycom:{secret_key}"
        is_valid = decoded_credentials == expected_credentials

        if not is_valid:
            print(f"Invalid credentials. Expected: {expected_credentials}, Got: {decoded_credentials}")

        return is_valid

    except Exception as e:
        print(f"ERROR checking Payme auth: {e}")
        return False


def tiyin_to_sum(amount_tiyin):
    """Tiyindan so'mga o'tkazish"""
    try:
        return float(amount_tiyin) / 100.0
    except:
        return 0.0


def sum_to_tiyin(amount_sum):
    """So'mdan tiyinga o'tkazish"""
    try:
        return int(float(amount_sum) * 100)
    except:
        return 0


def decode_payme_params(params_base64):
    """Payme parametrlarini decode qilish (debug uchun)"""
    try:
        decoded = base64.b64decode(params_base64).decode('utf-8')
        params = {}

        for param in decoded.split(';'):
            if '=' in param:
                key, value = param.split('=', 1)
                params[key] = value

        return params
    except:
        return {}
    