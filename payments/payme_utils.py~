# payments/payme_utils.py - YANGILANGAN VERSIYA
import base64
from django.conf import settings


def create_payme_link(telegram_id, amount):
    """
    Payme to'lov havolasini yaratish

    Args:
        telegram_id: Foydalanuvchi telegram ID
        amount: Summa (so'mda)

    Returns:
        str: To'lov havolasi
    """
    try:
        merchant_id = settings.PAYME_SETTINGS['MERCHANT_ID']

        # Summa tiyinga (1 so'm = 100 tiyin)
        amount_tiyin = int(float(amount) * 100)

        # Account parametrlarini to'g'ri formatda
        params = f"m={merchant_id};ac.telegram_id={telegram_id};a={amount_tiyin}"

        # Base64 kodlash
        encoded = base64.b64encode(params.encode('utf-8')).decode('utf-8')

        # URL yaratish
        url = f"https://checkout.paycom.uz/{encoded}"

        print(f"Payme URL created: {url}")  # Debug uchun

        return url
    except Exception as e:
        print(f"Error creating Payme link: {e}")
        return ""


def check_payme_auth(request):
    """
    Payme dan kelayotgan so'rovni tekshirish
    """
    auth_header = request.META.get('HTTP_AUTHORIZATION', '')

    if not auth_header.startswith('Basic '):
        return False

    try:
        # Base64 dan ochish
        encoded_credentials = auth_header.split(' ')[1]
        decoded_credentials = base64.b64decode(encoded_credentials).decode('utf-8')

        # Format: "Paycom:your_secret_key"
        expected_credentials = f"Paycom:{settings.PAYME_SETTINGS['SECRET_KEY']}"

        return decoded_credentials == expected_credentials
    except Exception as e:
        print(f"Auth error: {e}")
        return False


def tiyin_to_sum(amount_tiyin):
    """Tiyindan so'mga o'tkazish"""
    try:
        return float(amount_tiyin) / 100.0
    except:
        return 0


def sum_to_tiyin(amount_sum):
    """So'mdan tiyinga o'tkazish"""
    try:
        return int(float(amount_sum) * 100)
    except:
        return 0